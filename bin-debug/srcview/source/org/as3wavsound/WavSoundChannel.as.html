<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>WavSoundChannel.as</title>
<link rel="stylesheet" type="text/css" href="../../../SourceStyles.css"/>
</head>

<body><pre><span class="ActionScriptpackage">package</span> <span class="ActionScriptDefault_Text">org</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">as3wavsound</span> <span class="ActionScriptBracket/Brace">{</span>
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">events</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">EventDispatcher</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">media</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">SoundChannel</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">events</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Event</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">media</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">SoundTransform</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">as3wavsound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">sazameki</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">core</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">AudioSamples</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">as3wavsound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">WavSound</span>;

    <span class="ActionScriptASDoc">/**
     * Used to keep track of open channels during playback. Each channel represents
     * an 'instance' of a sound and so each channel is responsible for its own mixing.
     * 
     * Also see buffer().
     * 
     * @author b.bottema [Codemonkey]
     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">WavSoundChannel</span> <span class="ActionScriptReserved">extends</span> <span class="ActionScriptDefault_Text">EventDispatcher</span> <span class="ActionScriptBracket/Brace">{</span>
        
        <span class="ActionScriptComment">/*
         * creation-time information 
         */</span>
        
        <span class="ActionScriptComment">// the player to delegate play() stop() requests to
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">player</span>:<span class="ActionScriptDefault_Text">WavSoundPlayer</span>;
        
        <span class="ActionScriptComment">// a WavSound currently playing back on one or several channels
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_wavSound</span>:<span class="ActionScriptDefault_Text">WavSound</span>;
        
        <span class="ActionScriptComment">// works the same as SoundChannel.soundTransform
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_soundTransform</span>:<span class="ActionScriptDefault_Text">SoundTransform</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">SoundTransform</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        
        <span class="ActionScriptComment">/*
         * play-time information *per WavSound*
         */</span>
        
        <span class="ActionScriptComment">// starting phase if not at the beginning, made global to avoid recalculating all the time
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">startPhase</span>:<span class="ActionScriptDefault_Text">Number</span>; 
        <span class="ActionScriptComment">// current phase of the sound, basically matches a single current sample frame for each WavSound
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">phase</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptComment">// the current avarage volume of samples buffered to the left audiochannel
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_leftPeak</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptComment">// the current avarage volume of samples buffered to the right audiochannel
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_rightPeak</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptComment">// how many loops we need to buffer
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">loopsLeft</span>:<span class="ActionScriptDefault_Text">Number</span>;
        <span class="ActionScriptComment">// indicates if the phase has reached total sample count and no loops are left
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">finished</span>:<span class="ActionScriptDefault_Text">Boolean</span>;
        
        <span class="ActionScriptASDoc">/**
         * Constructor: pre-calculates starting phase (and performs some validation for this).
         */</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">WavSoundChannel</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">player</span>:<span class="ActionScriptDefault_Text">WavSoundPlayer</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">wavSound</span>:<span class="ActionScriptDefault_Text">WavSound</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">startTime</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">loops</span>:<span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">soundTransform</span>:<span class="ActionScriptDefault_Text">SoundTransform</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">this</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">player</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">player</span>;
            <span class="ActionScriptReserved">this</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_wavSound</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">wavSound</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">soundTransform</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">this</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_soundTransform</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">soundTransform</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">init</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">startTime</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">loops</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * Calculates and validates the starting time. Starting time in milliseconds is converted into 
         * sample position and then marked as starting phase.
         */</span>
        <span class="ActionScriptReserved">internal</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">init</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">startTime</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">loops</span>:<span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">startPositionInMillis</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">floor</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">startTime</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">maxPositionInMillis</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">floor</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_wavSound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">startPositionInMillis</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">maxPositionInMillis</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"startTime greater than sound's length, max startTime is "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">maxPositionInMillis</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">phase</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">startPhase</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">floor</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">startPositionInMillis</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">_wavSound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">samples</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">_wavSound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">finished</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptDefault_Text">loopsLeft</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loops</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">stop</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">player</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stop</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * Fills a target samplebuffer with optionally transformed samples from the current 
         * WavSound instance (which is the current channel).
         * 
         * Keeps filling the buffer for each loop the sound should be mixed in the target buffer.
         * When the buffer is full, phase and loopsLeft keep track of how which and many samples 
         * still need to be buffered in the next buffering cycle (when this method is called again).
         * 
         * @param    sampleBuffer The target buffer to mix in the current (transformed) samples.
         * @param    soundTransform The soundtransform that belongs to a single channel being played 
         *             (containing volume, panning etc.).
         */</span>    
        <span class="ActionScriptReserved">internal</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">buffer</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sampleBuffer</span>:<span class="ActionScriptDefault_Text">AudioSamples</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// calculate volume and panning
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">volume</span>: <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_soundTransform</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">volume</span> <span class="ActionScriptOperator">/</span> 1<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">volumeLeft</span>: <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">volume</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span>1 <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">_soundTransform</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">pan</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> 2;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">volumeRight</span>: <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">volume</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span>1 <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">_soundTransform</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">pan</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> 2;
            <span class="ActionScriptComment">// channel settings
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">needRightChannel</span>:<span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_wavSound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">playbackSettings</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">channels</span> <span class="ActionScriptOperator">==</span> 2;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">hasRightChannel</span>:<span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_wavSound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">samples</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">setting</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">channels</span> <span class="ActionScriptOperator">==</span> 2;
            
            <span class="ActionScriptComment">// extra references to avoid excessive getter calls in the following 
</span>            <span class="ActionScriptComment">// for-loop (it appeares CPU is being hogged otherwise)
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">samplesLength</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_wavSound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">samples</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">samplesLeft</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_wavSound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">samples</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">left</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">samplesRight</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_wavSound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">samples</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">right</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">sampleBufferLength</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">sampleBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">sampleBufferLeft</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">sampleBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">left</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">sampleBufferRight</span>:<span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">sampleBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">right</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">leftPeakRecord</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rightPeakRecord</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;
            
            <span class="ActionScriptComment">// finally, mix the samples in the master sample buffer
</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">finished</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">sampleBufferLength</span>; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">finished</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    
                        <span class="ActionScriptComment">// write (transformed) samples to buffer
</span>                        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">sampleLeft</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">samplesLeft</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">phase</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">volumeLeft</span>;
                        <span class="ActionScriptDefault_Text">sampleBufferLeft</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">sampleLeft</span>;
                        <span class="ActionScriptDefault_Text">leftPeakRecord</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">sampleLeft</span>;
                        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">channelValue</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">needRightChannel</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">hasRightChannel</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">?</span> <span class="ActionScriptDefault_Text">samplesRight</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">phase</span><span class="ActionScriptBracket/Brace">]</span> : <span class="ActionScriptDefault_Text">samplesLeft</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">phase</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">sampleRight</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">channelValue</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">volumeRight</span>;
                        <span class="ActionScriptDefault_Text">sampleBufferRight</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">sampleRight</span>;
                        <span class="ActionScriptDefault_Text">rightPeakRecord</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">sampleRight</span>;
                        
                        <span class="ActionScriptComment">// check playing and looping state
</span>                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">phase</span> <span class="ActionScriptOperator">&gt;=</span> <span class="ActionScriptDefault_Text">samplesLength</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                            <span class="ActionScriptDefault_Text">phase</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">startPhase</span>;
                            <span class="ActionScriptDefault_Text">finished</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopsLeft</span><span class="ActionScriptOperator">--</span> <span class="ActionScriptOperator">==</span> 0;
                        <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptBracket/Brace">}</span>
            
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">finished</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Event</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">Event</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">SOUND_COMPLETE</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptDefault_Text">_leftPeak</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">leftPeakRecord</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">sampleBufferLength</span>;
            <span class="ActionScriptDefault_Text">_rightPeak</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">rightPeakRecord</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">sampleBufferLength</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">internal</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">wavSound</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">WavSound</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_wavSound</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">leftPeak</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>: <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_leftPeak</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
          <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">rightPeak</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>: <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_rightPeak</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
          <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">position</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>: <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">phase</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">_wavSound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">_wavSound</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">samples</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">soundTransform</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">SoundTransform</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_soundTransform</span>;
        <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptBracket/Brace">}</span>
<span class="ActionScriptBracket/Brace">}</span></pre></body>
</html>
